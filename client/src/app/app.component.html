<div class="app-container">
  <!-- Header -->
  <app-header
    [isLoading]="isLoading"
    [isRenameMode]="isRenameMode"
    [playbackProgress]="playbackProgress"
    (search)="onSearch($event)"
    (refresh)="refreshSounds()"
    (toggleRenameMode)="toggleRenameMode()"
    (toggleSettings)="toggleSettingsModal()"
    (addSound)="openAddSoundModal()"
  ></app-header>

  <!-- Main Content -->
  <app-content
    [categories]="categories"
    [filteredSounds]="filteredSounds"
    [isLoading]="isLoading"
    [searchQuery]="searchQuery"
    [currentlyPlayingIndex]="currentlyPlayingIndex"
    [isRenameMode]="isRenameMode"
    [activeCategory]="activeCategory"
    (playSound)="playSound($event)"
    (openRenameModal)="openRenameModal($event)"
    (activeCategoryChange)="activeCategory = $event"
  ></app-content>

  <!-- Footer with Playback Controls -->
  <app-footer
    [isConnected]="isConnected"
    [currentlyPlayingIndex]="currentlyPlayingIndex"
    [isPaused]="isPaused"
    [playbackProgress]="playbackProgress"
    [playbackTimeRemaining]="playbackTimeRemaining"
    [volume]="volume"
    [playbackMode]="playbackMode"
    (stop)="stopSound()"
    (togglePause)="togglePause()"
    (volumeChange)="setVolume($event)"
    (playbackModeChange)="setPlaybackMode($event)"
  ></app-footer>

  <!-- Rename Modal -->
  <div class="modal-overlay" *ngIf="isRenameModalOpen" (click)="cancelRename()">
    <div class="modal-content rename-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Rename Sound</h2>
        <button class="close-btn" (click)="cancelRename()">&times;</button>
      </div>
      <div class="modal-body">
        <p class="rename-current-name">Current name: <strong>{{ soundToRename?.title }}</strong></p>
        <div class="rename-input-group">
          <input
            #renameInput
            type="text"
            class="rename-input"
            [(ngModel)]="renameValue"
            placeholder="Enter new name"
            (keydown.enter)="confirmRename()"
            (keydown.escape)="cancelRename()"
          />
        </div>
        <div class="rename-actions">
          <button class="rename-cancel-btn" (click)="cancelRename()">Cancel</button>
          <button
            class="rename-confirm-btn"
            (click)="confirmRename()"
            [disabled]="!renameValue.trim() || isRenaming"
          >
            <svg *ngIf="isRenaming" class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 6px;">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            {{ isRenaming ? 'Renaming...' : 'Confirm' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" *ngIf="isSettingsModalOpen" (click)="toggleSettingsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="close-btn" (click)="toggleSettingsModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h3>Auto-Reload</h3>
          <div class="settings-toggle-row">
            <div class="settings-toggle-info">
              <span class="settings-toggle-label">Soundlist change detection</span>
              <span class="settings-toggle-description">Automatically reload sounds when soundlist.spl changes on disk</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" [checked]="configWatchEnabled" (change)="toggleConfigWatch()" />
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h3>Soundpad Actions</h3>
          <p>If Soundpad is unresponsive or needs to be reloaded, you can restart it here.</p>
          <button
            class="restart-btn"
            (click)="restartSoundpad()"
            [disabled]="isRestarting"
          >
            <svg *ngIf="isRestarting" class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px; margin-right: 8px;">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            {{ isRestarting ? 'Restarting...' : 'Restart Soundpad' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Sound Modal -->
  <div class="modal-overlay" *ngIf="isAddSoundModalOpen" (click)="closeAddSoundModal()">
    <div class="modal-content add-sound-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add Sound</h2>
        <button class="close-btn" (click)="closeAddSoundModal()">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Drop Zone -->
        <div
          class="drop-zone"
          [class.drag-over]="isDragOver"
          [class.has-file]="addSoundFile !== null"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
          <input
            #fileInput
            type="file"
            accept=".mp3,.wav,.ogg,.flac,.aac,.wma,.m4a,.opus,.aiff,.ape"
            (change)="onFileSelected($event)"
            style="display: none"
          />
          <div *ngIf="!addSoundFile" class="drop-zone-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="drop-zone-icon">
              <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
            </svg>
            <p class="drop-zone-text">Drag & drop a sound file here</p>
            <p class="drop-zone-hint">or click to browse</p>
            <p class="drop-zone-formats">MP3, WAV, OGG, FLAC, AAC, WMA, M4A, OPUS, AIFF, APE</p>
          </div>
          <div *ngIf="addSoundFile" class="drop-zone-file">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="file-icon">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
            <div class="file-info">
              <p class="file-name">{{ addSoundFile.name }}</p>
              <p class="file-size">{{ formatFileSize(addSoundFile.size) }}</p>
            </div>
            <button class="remove-file-btn" (click)="removeFile($event)" title="Remove file">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Sound Name Input -->
        <div class="sound-name-section" *ngIf="addSoundFile">
          <label class="category-label">Sound Name</label>
          <input
            type="text"
            class="sound-name-input"
            [(ngModel)]="addSoundName"
            placeholder="Enter sound name"
          />
        </div>

        <!-- Category Selection -->
        <div class="category-select-section">
          <label class="category-label">Category</label>
          <select class="category-select" [(ngModel)]="addSoundCategory">
            <option *ngFor="let cat of addSoundCategories" [value]="cat.name">
              {{ cat.parentCategory ? '  â”” ' + cat.name : cat.name }}
            </option>
          </select>
        </div>

        <!-- Error message -->
        <p *ngIf="addSoundError" class="add-sound-error">{{ addSoundError }}</p>

        <!-- Actions -->
        <div class="add-sound-actions">
          <button class="rename-cancel-btn" (click)="closeAddSoundModal()">Cancel</button>
          <button
            class="add-sound-confirm-btn"
            (click)="confirmAddSound()"
            [disabled]="!addSoundFile || isAddingSound"
          >
            <svg *ngIf="isAddingSound" class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 6px;">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            {{ isAddingSound ? 'Adding...' : 'Add Sound' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
