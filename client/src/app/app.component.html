<div class="app-container" [class.wake-blur]="isWakeDialogOpen" [class.wake-dimmed]="isUiDimmed">
  <!-- Header -->
  <app-header
    [isReorderMode]="isReorderMode"
    [isQueueMode]="isQueueMode"
    [queueLength]="soundQueue.length"
    [playbackProgress]="playbackProgress"
    [showNsfw]="showNsfw"
    [nsfwModeEnabled]="nsfwModeEnabled"
    (search)="onSearch($event)"
    (toggleReorderMode)="toggleReorderMode()"
    (toggleQueueMode)="toggleQueueMode()"
    (toggleSettings)="toggleSettingsModal()"
    (addSound)="openAddSoundModal()"
    (toggleNsfwMode)="toggleNsfwMode()"
    (toggleStore)="toggleStoreModal()"
    [showVBCableBanner]="showVBCableBanner"
    (vbcableDismissed)="onVBCableDismissed()"
    (vbcableInstalled)="onVBCableInstalled()"
  ></app-header>

  <!-- Main Content / Settings / Store -->
  <app-content
    *ngIf="!isSettingsModalOpen && !isStoreOpen"
    [categories]="categories"
    [filteredSounds]="filteredSounds"
    [isLoading]="isLoading"
    [searchQuery]="searchQuery"
    [currentlyPlayingId]="currentlyPlayingId"
    [isReorderMode]="isReorderMode"
    [activeCategory]="activeCategory"
    [soundQueue]="soundQueue"
    [nsfwModeEnabled]="nsfwModeEnabled"
    (playSound)="playSound($event)"
    (activeCategoryChange)="activeCategory = $event"
    (reorderSound)="onReorderSound($event)"
    (reorderCategory)="onReorderCategory($event)"
    (dragStateChange)="onDragStateChange($event)"
    (soundContextMenu)="onSoundContextMenu($event)"
    (updateCategoryIcon)="onUpdateCategoryIcon($event)"
    (updateSoundIcon)="onUpdateSoundIcon($event)"
    (toggleCategoryNsfw)="onToggleCategoryNsfw($event)"
    (toggleCategoryVisibility)="onToggleCategoryVisibility($event)"
    (deleteCategory)="onDeleteCategory($event)"
  ></app-content>

  <app-settings
    *ngIf="isSettingsModalOpen"
    [keepAwakeEnabled]="keepAwakeEnabled"
    [idleTimeoutEnabled]="idleTimeoutEnabled"
    [wakeMinutes]="wakeMinutes"
    [serverPort]="serverPort"
    [isPortChanging]="isPortChanging"
    [portChangeError]="portChangeError"
    [autoUpdateCheckEnabled]="autoUpdateCheckEnabled"
    [updateCheckIntervalMinutes]="updateCheckIntervalMinutes"
    [isCheckingForUpdate]="isCheckingForUpdate"
    [latestVersion]="latestVersion"
    [updateAvailable]="updateAvailable"
    [nsfwModeEnabled]="nsfwModeEnabled"
    [storeServerUrl]="storeServerUrl"
    (saveSettings)="onSaveSettings($event)"
    (closeSettings)="toggleSettingsModal()"
    (checkForUpdates)="manualUpdateCheck()"
  ></app-settings>

  <app-store-modal
    *ngIf="isStoreOpen && !isSettingsModalOpen"
    (closed)="isStoreOpen = false"
    (categoryDownloaded)="onCategoryDownloaded($event)"
  ></app-store-modal>

  <!-- Footer with Playback Controls -->
  <app-footer
    [isConnected]="isConnected"
    [currentlyPlayingId]="currentlyPlayingId"
    [isPaused]="isPaused"
    [playbackProgress]="playbackProgress"
    [playbackTimeRemaining]="playbackTimeRemaining"
    [volume]="volume"
    [playbackMode]="playbackMode"
    [updateAvailable]="updateAvailable && !updateDismissed"
    [latestVersion]="latestVersion"
    [downloadUrl]="downloadUrl"
    (stop)="stopSound()"
    (togglePause)="togglePause()"
    (volumeChange)="setVolume($event)"
    (playbackModeChange)="setPlaybackMode($event)"
    (dismissUpdate)="dismissUpdate()"
  ></app-footer>

  <!-- Are You Still There? Dialog -->
  <app-wake-dialog
    [isOpen]="isWakeDialogOpen"
    [isUiDimmed]="isUiDimmed"
    [countdownSeconds]="wakeCountdownSeconds"
    (dismissed)="dismissWakeDialog()"
  ></app-wake-dialog>

  <!-- Add Sound Modal -->
  <app-add-sound-modal
    [isOpen]="isAddSoundModalOpen"
    [sounds]="sounds"
    [categoryIconsMap]="categoryIconsMap"
    (closed)="onAddSoundClosed()"
    (soundAdded)="onSoundAdded()"
  ></app-add-sound-modal>

  <!-- Context Menu (desktop Tauri build only) -->
  <app-context-menu
    [visible]="contextMenuVisible"
    [x]="contextMenuX"
    [y]="contextMenuY"
    [sound]="contextMenuSound"
    [nsfwModeEnabled]="nsfwModeEnabled"
    (closed)="onContextMenuClosed()"
    (editSound)="onContextMenuEdit()"
    (renameSound)="onContextMenuRename()"
    (deleteSound)="onContextMenuDelete()"
    (toggleNsfw)="onContextMenuToggleNsfw()"
  ></app-context-menu>

  <!-- Edit Sound Modal -->
  <app-edit-sound-modal
    [isOpen]="isEditSoundModalOpen"
    [sound]="soundToEdit"
    (closed)="onEditSoundClosed()"
    (saved)="onEditSoundSaved()"
  ></app-edit-sound-modal>

  <!-- Edit Details (Rename) Modal -->
  <app-edit-details-modal
    [isOpen]="isEditDetailsModalOpen"
    [sound]="soundToEditDetails"
    [sounds]="sounds"
    [categoryIconsMap]="categoryIconsMap"
    [nsfwModeEnabled]="nsfwModeEnabled"
    (closed)="onEditDetailsClosed()"
    (saved)="onEditDetailsSaved()"
  ></app-edit-details-modal>

  <!-- Delete Sound Confirmation Dialog -->
  <div class="modal-backdrop" *ngIf="isDeleteConfirmOpen" (click)="cancelDelete()">
    <div class="delete-confirm-dialog" (click)="$event.stopPropagation()">
      <h3>Delete Sound</h3>
      <p>Are you sure you want to delete <strong>{{ soundToDelete?.title }}</strong>?</p>
      <p class="delete-warning">This will permanently delete the sound and its audio file.</p>
      <div class="delete-confirm-actions">
        <button class="btn-cancel" (click)="cancelDelete()" [disabled]="isDeleting">Cancel</button>
        <button class="btn-delete" (click)="confirmDelete()" [disabled]="isDeleting">
          <span *ngIf="!isDeleting">Delete</span>
          <span *ngIf="isDeleting">Deleting...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Category Confirmation Dialog -->
  <div class="modal-backdrop" *ngIf="isDeleteCategoryConfirmOpen" (click)="cancelDeleteCategory()">
    <div class="delete-confirm-dialog" (click)="$event.stopPropagation()">
      <h3>Delete Category</h3>
      <p>Are you sure you want to delete <strong>{{ categoryToDelete }}</strong>?</p>
      <p class="delete-warning">This will permanently delete the category and all its sounds.</p>
      <div class="delete-confirm-actions">
        <button class="btn-cancel" (click)="cancelDeleteCategory()" [disabled]="isDeletingCategory">Cancel</button>
        <button class="btn-delete" (click)="confirmDeleteCategory()" [disabled]="isDeletingCategory">
          <span *ngIf="!isDeletingCategory">Delete</span>
          <span *ngIf="isDeletingCategory">Deleting...</span>
        </button>
      </div>
    </div>
  </div>
</div>
