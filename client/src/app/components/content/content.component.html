<main class="main-content" #mainContent cdkDropListGroup>
  <!-- Category Nav -->
  <nav class="category-nav" *ngIf="!isLoading && categories.length > 0">
    <ul class="category-nav-list" #categoryNavList>
      <li
        *ngFor="let category of categories; let i = index; trackBy: trackByCategory"
        class="category-nav-item"
        [class.active]="activeCategory === category.name && categoryDraggingIdx === -1"
        [class.category-reorder-mode]="isReorderMode"
        [class.category-dragging]="categoryDraggingIdx === i"
        [class.category-drag-target]="categoryDragOverIdx === i && categoryDragOverIdx !== categoryDraggingIdx"
        (click)="scrollToCategory(category.name)"
        cdkDropList
        cdkDropListSortingDisabled
        [cdkDropListDisabled]="!isReorderMode"
        [cdkDropListData]="{ category: category.name, sounds: category.sounds }"
        (cdkDropListDropped)="onNavDrop($event)"
      >
        {{ category.name }}
        <div
          *ngIf="isReorderMode"
          class="category-nav-drag-handle"
          (pointerdown)="onCategoryHandlePointerDown($event, i)"
          (click)="$event.stopPropagation()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
        </div>
      </li>
    </ul>
  </nav>

  <div class="main-content-inner">

    <!-- Sound Grid -->
    <section class="sounds-section">
    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
      <div class="spinner"></div>
      <p>Loading sounds...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoading && filteredSounds.length === 0 && !searchQuery">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
      </svg>
      <h2>No Sounds Found</h2>
      <p>Make sure the audio engine is running and has sounds loaded.</p>
    </div>

    <!-- No Results State -->
    <div class="empty-state" *ngIf="!isLoading && filteredSounds.length === 0 && searchQuery">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="11" cy="11" r="8" fill="none" stroke="currentColor" stroke-width="2"/>
        <path d="M21 21l-4.35-4.35" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>
      <h2>No Results</h2>
      <p>No sounds match "{{ searchQuery }}"</p>
    </div>

    <!-- Sound Grid - Centered -->
    <div class="sounds-grid-wrapper" *ngIf="!isLoading && filteredSounds.length > 0">
      <div class="categories-container" #categoriesContainer>
        <div class="category-section"
             *ngFor="let category of categories; trackBy: trackByCategory"
             [attr.data-category]="category.name"
             #categoryElement>
          <!-- Category Divider -->
          <div class="category-divider">
            <div class="category-icon"
                 [class.has-image]="hasValidImage(category)"
                 [class.icon-drag-over]="iconDragOverCategory === category.name"
                 (dragover)="onIconDragOver($event, category.name)"
                 (dragleave)="onIconDragLeave($event)"
                 (drop)="onIconDrop($event, category.name)">
              <img *ngIf="hasValidImage(category)" [src]="category.image" alt="{{ category.name }}" (error)="onImageError(category)" />
              <svg *ngIf="!hasValidImage(category)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
              </svg>
            </div>
            <h2 class="category-title">{{ category.name }}</h2>
            <span class="nsfw-category-badge" *ngIf="category.nsfw && nsfwModeEnabled">18+</span>
            <button
              class="nsfw-category-toggle"
              *ngIf="isReorderMode && nsfwModeEnabled"
              [class.active]="category.nsfw"
              (click)="toggleCategoryNsfw.emit({ categoryName: category.name, nsfw: !category.nsfw }); $event.stopPropagation()"
              title="{{ category.nsfw ? 'Unmark category as NSFW' : 'Mark category as NSFW' }}"
            >NSFW</button>
            <button
              class="visibility-category-toggle"
              *ngIf="isReorderMode"
              [class.active]="category.visibility === 'public'"
              (click)="toggleCategoryVisibility.emit({ categoryName: category.name, visibility: category.visibility === 'public' ? 'private' : 'public' }); $event.stopPropagation()"
              title="{{ category.visibility === 'public' ? 'Make category private' : 'Make category public' }}"
            >
              <!-- Globe icon (public) -->
              <svg *ngIf="category.visibility === 'public'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
              </svg>
              <!-- Lock icon (private) -->
              <svg *ngIf="category.visibility !== 'public'" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
              </svg>
            </button>
            <button
              class="delete-category-btn"
              *ngIf="isReorderMode"
              (click)="deleteCategory.emit(category.name); $event.stopPropagation()"
              title="Delete category '{{ category.name }}'"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
              </svg>
            </button>
            <span class="category-count">{{ getTotalSoundCount(category) }} sounds</span>
            <div class="category-line"></div>
          </div>

          <!-- Direct sounds in this category (not in sub-categories) - Normal mode -->
          <div class="sounds-grid" *ngIf="category.sounds.length > 0 && !isReorderMode">
            <app-sound-card
              *ngFor="let sound of category.sounds; trackBy: trackByIndex"
              [sound]="sound"
              [isPlaying]="currentlyPlayingId === sound.id"
              [queuePositions]="getQueuePositions(sound.id)"
              (play)="onPlaySound($event)"
              (soundContextMenu)="onSoundContextMenu($event)"
              (iconDropped)="updateSoundIcon.emit($event)"
            ></app-sound-card>
          </div>

          <!-- Direct sounds in this category - Reorder mode with drag-and-drop -->
          <!-- Always render the single drop list in reorder mode so CDK never
               loses the container reference when the last item is dragged out -->
          <div class="sounds-grid reorder-grid"
               *ngIf="isReorderMode"
               [class.empty-drop-zone]="category.sounds.length === 0 && category.subCategories.length === 0"
               cdkDropList
               cdkDropListOrientation="mixed"
               [cdkDropListData]="{ category: category.name, sounds: category.sounds }"
               [cdkDropListSortPredicate]="sortPredicate"
               (cdkDropListDropped)="onDrop($event)">
            <div class="drag-card-wrapper"
                 *ngFor="let sound of category.sounds; trackBy: trackByIndex"
                 cdkDrag
                 [cdkDragData]="sound"
                 (cdkDragStarted)="onDragStarted($event)">
              <div class="drag-placeholder" *cdkDragPlaceholder></div>
              <app-sound-card
                [sound]="sound"
                [isPlaying]="currentlyPlayingId === sound.id"
                (soundContextMenu)="onSoundContextMenu($event)"
                (iconDropped)="updateSoundIcon.emit($event)"
                class="reorder-card"
              ></app-sound-card>
              <div class="drag-handle">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
              </div>
            </div>
            <div class="empty-drop-hint" *ngIf="category.sounds.length === 0 && category.subCategories.length === 0">Drop sounds here</div>
          </div>

          <!-- Sub-categories -->
          <div class="sub-categories-container" *ngIf="category.subCategories.length > 0">
            <div class="sub-category-section"
                 *ngFor="let subCategory of category.subCategories; trackBy: trackByCategory">
              <!-- Sub-category Divider -->
              <div class="sub-category-divider">
                <div class="sub-category-icon"
                     [class.has-image]="hasValidImage(subCategory)"
                     [class.icon-drag-over]="iconDragOverCategory === subCategory.name"
                     (dragover)="onIconDragOver($event, subCategory.name)"
                     (dragleave)="onIconDragLeave($event)"
                     (drop)="onIconDrop($event, subCategory.name)">
                  <img *ngIf="hasValidImage(subCategory)" [src]="subCategory.image" alt="{{ subCategory.name }}" (error)="onImageError(subCategory)" />
                  <svg *ngIf="!hasValidImage(subCategory)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                  </svg>
                </div>
                <h3 class="sub-category-title">{{ subCategory.name }}</h3>
                <span class="sub-category-count">{{ subCategory.sounds.length }} sounds</span>
                <div class="sub-category-line"></div>
              </div>

              <!-- Sounds Grid for this sub-category - Normal mode -->
              <div class="sounds-grid" *ngIf="!isReorderMode">
                <app-sound-card
                  *ngFor="let sound of subCategory.sounds; trackBy: trackByIndex"
                  [sound]="sound"
                  [isPlaying]="currentlyPlayingId === sound.id"
                  (play)="onPlaySound($event)"
                  (soundContextMenu)="onSoundContextMenu($event)"
                  (iconDropped)="updateSoundIcon.emit($event)"
                ></app-sound-card>
              </div>

              <!-- Sounds Grid for this sub-category - Reorder mode -->
              <div class="sounds-grid reorder-grid"
                   *ngIf="isReorderMode"
                   cdkDropList
                   cdkDropListOrientation="mixed"
                   [cdkDropListData]="{ category: subCategory.name, sounds: subCategory.sounds }"
                   [cdkDropListSortPredicate]="sortPredicate"
                   (cdkDropListDropped)="onDrop($event)">
                <div class="drag-card-wrapper"
                     *ngFor="let sound of subCategory.sounds; trackBy: trackByIndex"
                     cdkDrag
                     [cdkDragData]="sound"
                     (cdkDragStarted)="onDragStarted($event)">
                  <div class="drag-placeholder" *cdkDragPlaceholder></div>
                  <app-sound-card
                    [sound]="sound"
                    [isPlaying]="currentlyPlayingId === sound.id"
                    (soundContextMenu)="onSoundContextMenu($event)"
                    (iconDropped)="updateSoundIcon.emit($event)"
                    class="reorder-card"
                  ></app-sound-card>
                  <div class="drag-handle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                    </svg>
                  </div>
                </div>
                <!-- Empty state for sub-category -->
                <div class="empty-drop-hint" *ngIf="subCategory.sounds.length === 0">Drop sounds here</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Spacer to allow last category to scroll to top -->
        <div class="scroll-end-spacer" #scrollEndSpacer></div>
      </div>
    </div>
  </section>
  </div>
</main>
