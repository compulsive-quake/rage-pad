<div class="modal-overlay" *ngIf="isOpen" (click)="close()">
  <div class="modal-content edit-sound-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Edit Sound</h2>
      <button class="close-btn" (click)="close()">&times;</button>
    </div>
    <div class="modal-body edit-sound-modal-body">

      <!-- Loading state -->
      <div class="loading-state" *ngIf="isLoading">
        <svg class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
        </svg>
        <span>Loading audio...</span>
      </div>

      <!-- Error state -->
      <p *ngIf="errorMessage && !isLoading" class="edit-sound-error">{{ errorMessage }}</p>

      <!-- Waveform preview -->
      <div class="waveform-area" [class.step-hidden]="isLoading || !audioFile">
        <app-waveform-preview
          [file]="audioFile"
          (fileChanged)="onWaveformFileChanged($event)"
          (originalFileChanged)="onOriginalFileChanged($event)"
          (durationChanged)="onDurationChanged($event)"
          (cropStateChanged)="onCropStateChanged($event)"
        ></app-waveform-preview>
      </div>

      <!-- Actions footer -->
      <div class="edit-sound-actions" *ngIf="!isLoading">
        <button class="rename-cancel-btn" (click)="close()" [disabled]="isSaving">Cancel</button>
        <button
          class="save-copy-btn"
          (click)="onSaveACopy()"
          [disabled]="!audioFile || isSaving"
        >Save a Copy</button>
        <button
          class="add-sound-confirm-btn"
          (click)="onSave()"
          [disabled]="!audioFile || isSaving"
        >
          <svg *ngIf="isSaving" class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 6px;">
            <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
          </svg>
          {{ isSaving ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </div>

    <!-- Unapplied crop confirmation dialog -->
    <div class="crop-confirm-overlay" *ngIf="showCropConfirmDialog" (click)="onCropConfirmCancel()">
      <div class="crop-confirm-dialog" (click)="$event.stopPropagation()">
        <h3>Unapplied Crop</h3>
        <p>You've set crop handles but haven't clicked "Crop" to apply them. The sound will be saved without cropping.</p>
        <div class="crop-confirm-actions">
          <button class="crop-confirm-back-btn" (click)="onCropConfirmCancel()">Go Back</button>
          <button class="crop-confirm-continue-btn" (click)="onCropConfirmContinue()">Continue Without Cropping</button>
        </div>
      </div>
    </div>

    <!-- Save a Copy name dialog -->
    <div class="crop-confirm-overlay" *ngIf="showCopyNameDialog" (click)="onCopyNameCancel()">
      <div class="crop-confirm-dialog" (click)="$event.stopPropagation()">
        <h3>Save a Copy</h3>
        <p>Enter a name for the copy:</p>
        <input
          type="text"
          class="sound-name-input"
          [(ngModel)]="copyName"
          placeholder="Enter name"
          (keydown.enter)="onCopyNameConfirm()"
        />
        <div class="crop-confirm-actions copy-name-actions">
          <button class="crop-confirm-back-btn" (click)="onCopyNameCancel()">Cancel</button>
          <button class="crop-confirm-continue-btn save-copy-confirm-btn" (click)="onCopyNameConfirm()">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>
