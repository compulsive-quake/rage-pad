<div class="waveform-preview-section" *ngIf="file" (keydown)="onPreviewKeydown($event)" tabindex="-1" #waveformSection>
  <!-- Loading state -->
  <div *ngIf="previewLoading" class="waveform-loading">
    <div class="waveform-spinner"></div>
    <span>Analyzing audio...</span>
  </div>

  <!-- Frequency scope -->
  <div *ngIf="!previewLoading" class="frequency-scope-container">
    <canvas #frequencyCanvas class="frequency-scope-canvas"></canvas>
  </div>

  <!-- Waveform canvas + crop UI -->
  <div *ngIf="!previewLoading" class="waveform-container" (click)="$event.stopPropagation()">
    <!-- Canvas for waveform drawing -->
    <canvas
      #waveformCanvas
      class="waveform-canvas"
      (mousedown)="onWaveformMousedown($event)"
    ></canvas>

    <!-- Crop overlay: left muted region -->
    <div
      class="crop-region crop-region-left"
      [style.width.%]="cropStart * 100"
    ></div>

    <!-- Crop overlay: right muted region -->
    <div
      class="crop-region crop-region-right"
      [style.width.%]="(1 - cropEnd) * 100"
    ></div>

    <!-- Playhead -->
    <div
      class="playhead"
      [style.left.%]="previewPlayheadPos * 100"
      [class.visible]="previewIsPlaying || previewPlayheadPos > 0"
    ></div>

    <!-- Crop handle: start -->
    <div
      class="crop-handle crop-handle-start"
      [style.left.%]="cropStart * 100"
      [class.focused]="focusedCropHandle === 'start'"
      (mousedown)="startCropDrag($event, 'start')"
      (click)="$event.stopPropagation()"
      title="Drag to set start crop point (← → to fine-tune)"
    >
      <div class="crop-handle-line"></div>
      <div class="crop-handle-grip crop-handle-grip-start">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
      </div>
      <div class="crop-handle-label">{{ formatTime(cropStart * previewDuration) }}</div>
    </div>

    <!-- Crop handle: end -->
    <div
      class="crop-handle crop-handle-end"
      [style.left.%]="cropEnd * 100"
      [class.focused]="focusedCropHandle === 'end'"
      (mousedown)="startCropDrag($event, 'end')"
      (click)="$event.stopPropagation()"
      title="Drag to set end crop point (← → to fine-tune)"
    >
      <div class="crop-handle-line"></div>
      <div class="crop-handle-grip crop-handle-grip-end">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 5v14L5 12z"/></svg>
      </div>
      <div class="crop-handle-label">{{ formatTime(cropEnd * previewDuration) }}</div>
    </div>
  </div>

  <!-- Playback controls row -->
  <div *ngIf="!previewLoading" class="preview-controls">
    <button
      class="preview-play-btn"
      (click)="togglePreviewPlayback()"
      [title]="previewIsPlaying ? 'Pause' : 'Play (Space = restart from crop start)'"
    >
      <!-- Play icon -->
      <svg *ngIf="!previewIsPlaying" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M8 5v14l11-7z"/>
      </svg>
      <!-- Pause icon -->
      <svg *ngIf="previewIsPlaying" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
      </svg>
    </button>

    <div class="preview-time-info">
      <span class="preview-current-time">{{ formatTime(previewCurrentTime) }}</span>
      <span class="preview-time-sep">/</span>
      <span class="preview-duration">{{ formatTime(previewDuration) }}</span>
    </div>

    <div class="preview-crop-info" *ngIf="cropStart > 0 || cropEnd < 1">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="crop-icon">
        <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
      </svg>
      <span>Crop: {{ formatTime(cropStart * previewDuration) }} – {{ formatTime(cropEnd * previewDuration) }}</span>
      <span class="crop-duration">({{ formatTime((cropEnd - cropStart) * previewDuration) }})</span>
      <button class="apply-crop-btn" (click)="applyCrop()" [disabled]="isCropping" title="Apply crop – trims the audio to the selected region">
        <svg *ngIf="isCropping" class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 12px; height: 12px; margin-right: 4px;">
          <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
        </svg>
        {{ isCropping ? 'Cropping…' : 'Crop' }}
      </button>
      <button class="reset-crop-btn" (click)="resetCrop()" title="Reset crop">Reset</button>
    </div>

    <div class="preview-crop-info preview-crop-info--original" *ngIf="originalFile !== null && cropStart === 0 && cropEnd === 1">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="crop-icon crop-icon--applied">
        <path d="M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"/>
      </svg>
      <span class="crop-applied-label">Crop applied</span>
      <span class="crop-duration">({{ formatTime(previewDuration) }})</span>
      <button class="reset-to-original-btn" (click)="resetToOriginal()" title="Restore the original full-length audio">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 12px; height: 12px; margin-right: 4px;">
          <path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
        </svg>
        Reset to Original
      </button>
    </div>

    <div class="volume-controls">
      <button *ngIf="volumeGain !== 1.0" class="volume-reset-btn" (click)="resetVolume()" title="Reset to original volume">Reset</button>
      <input
        type="range"
        class="volume-slider"
        min="0"
        [max]="volumeSliderMax"
        [value]="volumeGain * 100"
        (input)="onVolumeSliderInput($event)"
        (change)="onVolumeSliderChange()"
        title="Volume"
      />
      <span class="volume-label">{{ (volumeGain * 100).toFixed(0) }}%</span>
      <button class="volume-normalize-btn" (click)="normalizeVolume()" title="Maximize volume without clipping">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 12px; height: 12px;">
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
        Max
      </button>
    </div>

    <div class="preview-hint">
      <span>Space: play/pause &nbsp;·&nbsp; Click waveform: seek &nbsp;·&nbsp; Drag handles or click + ←→: crop &nbsp;·&nbsp; Crop button: apply &amp; trim audio</span>
    </div>
  </div>
</div>
