<div class="modal-overlay" *ngIf="isOpen" (click)="flashCancelBtn()">
  <div class="modal-content add-sound-modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ step === 'select' ? 'Add Sound' : step === 'preview' ? 'Preview & Crop' : 'Sound Details' }}</h2>
      <button class="close-btn" (click)="close()">&times;</button>
    </div>
    <div class="modal-body add-sound-modal-body" (click)="blurCropHandles()">

      <!-- Step 1: Select file -->
      <div class="step-content" *ngIf="step === 'select'">
        <!-- Drop Zone -->
        <div
          class="drop-zone"
          [class.drag-over]="isDragOver"
          (dragover)="onDragOver($event)"
          (dragleave)="onDragLeave($event)"
          (drop)="onDrop($event)"
          (click)="fileInput.click()"
        >
          <input
            #fileInput
            type="file"
            accept=".mp3,.wav,.ogg,.flac,.aac,.wma,.m4a,.opus,.aiff,.ape"
            (change)="onFileSelected($event)"
            style="display: none"
          />
          <div class="drop-zone-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="drop-zone-icon">
              <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
            </svg>
            <p class="drop-zone-text">Drag & drop a sound file here</p>
            <p class="drop-zone-hint">or click to browse</p>
            <p class="drop-zone-formats">MP3, WAV, OGG, FLAC, AAC, WMA, M4A, OPUS, AIFF, APE</p>
          </div>
        </div>

        <!-- YouTube URL Input -->
        <div class="youtube-url-section">
          <div class="youtube-url-label">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="youtube-icon">
              <path d="M21.58 7.19c-.23-.86-.91-1.54-1.77-1.77C18.25 5 12 5 12 5s-6.25 0-7.81.42c-.86.23-1.54.91-1.77 1.77C2 8.75 2 12 2 12s0 3.25.42 4.81c.23.86.91 1.54 1.77 1.77C5.75 19 12 19 12 19s6.25 0 7.81-.42c.86-.23 1.54-.91 1.77-1.77C22 15.25 22 12 22 12s0-3.25-.42-4.81zM10 15V9l5.2 3-5.2 3z"/>
            </svg>
            <span>Or paste a YouTube URL</span>
          </div>
          <div class="youtube-url-input-wrapper">
            <div class="youtube-url-input-row">
              <input
                #youtubeInput
                type="url"
                class="youtube-url-input"
                [(ngModel)]="youtubeUrl"
                placeholder="https://www.youtube.com/watch?v=..."
                [disabled]="isFetchingYoutube || isAddingSound"
                (keydown.enter)="fetchFromYoutube()"
                (input)="onYoutubeUrlInput()"
                (focus)="onYoutubeUrlFocus()"
                (blur)="onYoutubeUrlBlur()"
                autocomplete="off"
              />
              <button
                class="youtube-fetch-btn"
                (click)="fetchFromYoutube()"
                [disabled]="!youtubeUrl.trim() || isFetchingYoutube || isAddingSound"
                title="Fetch audio from YouTube"
              >
                <svg *ngIf="isFetchingYoutube" class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                  <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                <svg *ngIf="!isFetchingYoutube" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                <span>{{ isFetchingYoutube ? 'Fetching...' : 'Fetch' }}</span>
              </button>
            </div>
            <!-- Recent YouTube videos dropdown -->
            <ul class="recent-videos-dropdown" *ngIf="showRecentVideos && recentYoutubeVideos.length > 0">
              <li class="recent-videos-header">
                <span class="recent-videos-header-left">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 12px; height: 12px;">
                    <path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42A8.954 8.954 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                  </svg>
                  {{ youtubeUrl.trim() ? 'Matching Cached Videos' : 'Recently Cached' }}
                </span>
                <button
                  class="clear-recent-btn"
                  (mousedown)="clearRecentVideos($event)"
                  title="Clear cached videos"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 11px; height: 11px;">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                  </svg>
                  Clear
                </button>
              </li>
              <li
                *ngFor="let video of recentYoutubeVideos"
                class="recent-video-item"
                (mousedown)="selectRecentVideo(video)"
              >
                <img
                  *ngIf="video.thumbnail"
                  [src]="video.thumbnail"
                  class="recent-video-thumb"
                  alt=""
                  loading="lazy"
                  referrerpolicy="no-referrer"
                />
                <div *ngIf="!video.thumbnail" class="recent-video-thumb-placeholder">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21.58 7.19c-.23-.86-.91-1.54-1.77-1.77C18.25 5 12 5 12 5s-6.25 0-7.81.42c-.86.23-1.54.91-1.77 1.77C2 8.75 2 12 2 12s0 3.25.42 4.81c.23.86.91 1.54 1.77 1.77C5.75 19 12 19 12 19s6.25 0 7.81-.42c.86-.23 1.54-.91 1.77-1.77C22 15.25 22 12 22 12s0-3.25-.42-4.81zM10 15V9l5.2 3-5.2 3z"/>
                  </svg>
                </div>
                <div class="recent-video-info">
                  <span class="recent-video-title">{{ video.title }}</span>
                  <span class="recent-video-meta">
                    <span class="recent-video-duration" *ngIf="video.durationSeconds">{{ formatDuration(video.durationSeconds) }}</span>
                    <span class="recent-video-cached-badge">cached</span>
                  </span>
                </div>
              </li>
            </ul>
          </div>
          <!-- YouTube loading indicator -->
          <div *ngIf="isFetchingYoutube" class="youtube-loading">
            <div *ngIf="youtubeTitle" class="youtube-title-preview">{{ youtubeTitle }}</div>
            <div class="youtube-loading-bar">
              <div
                class="youtube-loading-progress"
                [class.indeterminate]="youtubePhase !== 'downloading'"
                [style.width.%]="youtubePhase === 'downloading' ? youtubeProgressPercent : null"
              ></div>
            </div>
            <span class="youtube-loading-text">
              <ng-container *ngIf="youtubePhase === 'metadata'">Fetching metadata…</ng-container>
              <ng-container *ngIf="youtubePhase === 'downloading'">
                Downloading… {{ youtubeProgressPercent | number:'1.0-0' }}%
                <ng-container *ngIf="youtubeSpeed"> at {{ youtubeSpeed }}</ng-container>
                <ng-container *ngIf="youtubeEta"> ETA {{ youtubeEta }}</ng-container>
              </ng-container>
              <ng-container *ngIf="youtubePhase === 'processing'">Processing…</ng-container>
              <ng-container *ngIf="!youtubePhase">Connecting…</ng-container>
            </span>
          </div>
          <!-- YouTube fetch error -->
          <div *ngIf="youtubeFetchError" class="youtube-fetch-error-row">
            <p class="youtube-fetch-error">{{ youtubeFetchError }}</p>
            <button *ngIf="showYoutubeRetryBtn" class="youtube-retry-btn" (click)="retryYoutubeFetch()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 14px; height: 14px;">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
              </svg>
              Retry
            </button>
          </div>
        </div>

        <!-- Error message (file validation) -->
        <p *ngIf="addSoundError" class="add-sound-error">{{ addSoundError }}</p>
      </div>

      <!-- Step 2: Preview & Crop (CSS toggle to keep AudioContext alive) -->
      <div class="step-content" [class.step-hidden]="step !== 'preview'">
        <!-- Compact selected file bar -->
        <div class="selected-file-bar" *ngIf="addSoundFile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="selected-file-icon">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
          </svg>
          <span class="selected-file-name">{{ addSoundFile.name }}</span>
          <span class="selected-file-size">{{ formatFileSize(addSoundFile.size) }}</span>
          <button class="selected-file-remove" (click)="removeFile()" title="Remove file">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>

        <!-- Waveform Preview -->
        <app-waveform-preview
          [file]="addSoundFile"
          (fileChanged)="onWaveformFileChanged($event)"
          (originalFileChanged)="onOriginalFileChanged($event)"
          (metadataParsed)="onMetadataParsed($event)"
          (durationChanged)="onDurationChanged($event)"
          (cropStateChanged)="onCropStateChanged($event)"
        ></app-waveform-preview>
      </div>

      <!-- Step 3: Sound Details -->
      <div class="step-content" *ngIf="step === 'details'">
        <div class="add-sound-form-fields">
          <!-- Title (full width) -->
          <div class="form-field-col">
            <label class="category-label">Title <span class="required-star">*</span></label>
            <input
              type="text"
              class="sound-name-input"
              [(ngModel)]="addSoundName"
              placeholder="Enter title (required)"
            />
          </div>

          <!-- Row 2: Artist | Category -->
          <div class="form-fields-row">
            <!-- Artist -->
            <div class="form-field-col">
              <label class="category-label">Artist</label>
              <div class="field-input-row artist-autocomplete-wrapper">
                <input
                  type="text"
                  class="sound-name-input"
                  [(ngModel)]="addSoundArtist"
                  placeholder="Enter artist"
                  autocomplete="off"
                  (input)="onArtistInput()"
                  (focus)="onArtistFocus()"
                  (blur)="onArtistBlur()"
                />
                <button
                  class="field-clear-btn"
                  *ngIf="addSoundArtist"
                  (click)="addSoundArtist = ''; showArtistSuggestions = false"
                  title="Clear artist"
                  type="button"
                >&times;</button>
                <!-- Autocomplete dropdown -->
                <ul class="artist-suggestions" *ngIf="showArtistSuggestions">
                  <li
                    *ngFor="let artist of filteredArtistSuggestions"
                    class="artist-suggestion-item"
                    (mousedown)="selectArtistSuggestion(artist)"
                  >{{ artist }}</li>
                </ul>
              </div>
            </div>
            <!-- Category -->
            <div class="form-field-col">
              <label class="category-label">Category</label>
              <app-category-select
                [categories]="addSoundCategories"
                [categoryIconsMap]="categoryIconsMap"
                [selected]="addSoundCategory"
                (selectionChange)="onCategoryChange($event)"
              ></app-category-select>
            </div>
          </div>

          <!-- Error message -->
          <p *ngIf="addSoundError" class="add-sound-error">{{ addSoundError }}</p>
        </div>
      </div>

      <!-- Actions footer (adapts per step) -->
      <div class="add-sound-actions">
        <!-- Select step: Cancel only -->
        <ng-container *ngIf="step === 'select'">
          <button class="rename-cancel-btn" [class.flash-cancel]="isAddSoundCancelFlashing" (click)="close()">Cancel</button>
        </ng-container>

        <!-- Preview step: Back + Continue -->
        <ng-container *ngIf="step === 'preview'">
          <button class="rename-cancel-btn" (click)="goBackToSelect()">Back</button>
          <button class="add-sound-confirm-btn" (click)="goToDetails()">Continue</button>
        </ng-container>

        <!-- Details step: Back + Add Sound -->
        <ng-container *ngIf="step === 'details'">
          <button class="rename-cancel-btn" (click)="goBackToPreview()">Back</button>
          <button
            class="add-sound-confirm-btn"
            (click)="confirmAddSound()"
            [disabled]="!addSoundFile || isAddingSound || !addSoundName.trim()"
          >
            <svg *ngIf="isAddingSound" class="spinning" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 6px;">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            {{ isAddingSound ? 'Adding...' : 'Add Sound' }}
          </button>
        </ng-container>
      </div>
    </div>

    <!-- Unapplied crop confirmation dialog -->
    <div class="crop-confirm-overlay" *ngIf="showCropConfirmDialog" (click)="onCropConfirmCancel()">
      <div class="crop-confirm-dialog" (click)="$event.stopPropagation()">
        <h3>Unapplied Crop</h3>
        <p>You've set crop handles but haven't clicked "Crop" to apply them. The sound will be added without cropping.</p>
        <div class="crop-confirm-actions">
          <button class="crop-confirm-back-btn" (click)="onCropConfirmCancel()">Go Back</button>
          <button class="crop-confirm-continue-btn" (click)="onCropConfirmContinue()">Continue Without Cropping</button>
        </div>
      </div>
    </div>
  </div>
</div>
